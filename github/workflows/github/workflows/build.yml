name: Build and Test

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 2 * * *'  # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ package.json Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if [ ! -f "package.json" ]; then
          echo '{
  "name": "electrical-accounting",
  "version": "1.0.0",
  "description": "Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©",
  "main": "index.html",
  "scripts": {
    "test": "echo \"No tests specified\"",
    "build": "echo \"Building...\"",
    "lint": "echo \"Linting...\""
  },
  "keywords": ["accounting", "electrical", "arabic"],
  "author": "",
  "license": "MIT"
}' > package.json
        fi
        npm install
        
    - name: Validate HTML
      uses: anishathalye/proof-html@v2
      
    - name: Validate CSS
      run: |
        if [ -f "css/styles.css" ]; then
          echo "Validating CSS..."
          # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆØ§Øª ØªØ­Ù‚Ù‚ CSS Ù‡Ù†Ø§
        else
          echo "No CSS files found"
        fi
        
    - name: Validate JavaScript
      run: |
        # ÙØ­Øµ Ø¬ÙˆØ¯Ø© JavaScript
        if [ -f "js/app.js" ]; then
          echo "Checking JavaScript files..."
          # ÙØ­Øµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          for js_file in js/*.js; do
            if [ -f "$js_file" ]; then
              echo "Checking $js_file"
              node -c "$js_file" || echo "Error in $js_file"
            fi
          done
        fi
        
    - name: Check for errors
      run: |
        # ÙØ­Øµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
        echo "Checking for common issues..."
        
        # 1. ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        required_files=("index.html" "manifest.json")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          fi
        done
        
        # 2. ÙØ­Øµ Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
        if [ ! -d "css" ]; then
          echo "âš  Warning: css directory not found"
        fi
        
        if [ ! -d "js" ]; then
          echo "âš  Warning: js directory not found"
        fi
        
        echo "âœ… All checks passed"
        
    - name: Security scan
      uses: shiftleftsecurity/scan-action@master
      with:
        output: reports
        type: "js"
        
    - name: Archive build
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: electrical-accounting-build
        path: |
          .
          !node_modules/
          
    - name: Create build report
      run: |
        echo "# Build Report" > build-report.md
        echo "## Summary" >> build-report.md
        echo "- âœ… Build completed successfully" >> build-report.md
        echo "- ðŸ“… $(date)" >> build-report.md
        echo "- ðŸ—ï¸ Branch: ${{ github.ref }}" >> build-report.md
        echo "" >> build-report.md
        echo "## File Structure" >> build-report.md
        echo '```' >> build-report.md
        find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.json" | sort >> build-report.md
        echo '```' >> build-report.md
        
    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md
