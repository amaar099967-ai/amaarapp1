name: PWA Validation

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  validate-pwa:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate PWA requirements
      run: |
        echo "ðŸ” Validating PWA requirements..."
        
        # 1. ÙØ­Øµ ÙˆØ¬ÙˆØ¯ manifest.json
        if [ ! -f "manifest.json" ]; then
          echo "âŒ Missing manifest.json"
          exit 1
        else
          echo "âœ… Found manifest.json"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­ØªÙˆÙ‰ manifest
          if ! jq -e . manifest.json > /dev/null 2>&1; then
            echo "âŒ manifest.json is not valid JSON"
            exit 1
          fi
        fi
        
        # 2. ÙØ­Øµ ÙˆØ¬ÙˆØ¯ service worker
        if [ ! -f "sw.js" ]; then
          echo "âš  Warning: No service worker found"
        else
          echo "âœ… Found service worker"
        fi
        
        # 3. ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
        if [ -d "icons" ] || [ -d "images" ]; then
          echo "âœ… Found icons directory"
        else
          echo "âš  Warning: No icons directory found"
        fi
        
        # 4. ÙØ­Øµ HTML
        if [ -f "index.html" ]; then
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ meta tags
          if grep -q "viewport" index.html; then
            echo "âœ… Found viewport meta tag"
          else
            echo "âš  Warning: Missing viewport meta tag"
          fi
          
          if grep -q "theme-color" index.html; then
            echo "âœ… Found theme-color meta tag"
          else
            echo "âš  Warning: Missing theme-color meta tag"
          fi
        fi
        
        echo "âœ… PWA validation completed"
        
    - name: Run Lighthouse audit
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './lighthouse.config.js'
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: Generate PWA report
      run: |
        echo "# ØªÙ‚Ø±ÙŠØ± PWA" > pwa-report.md
        echo "## Ø§Ù„Ù†ØªØ§Ø¦Ø¬" >> pwa-report.md
        echo "- âœ… manifest.json: Ù…ÙˆØ¬ÙˆØ¯" >> pwa-report.md
        echo "- âš  service worker: $(if [ -f "sw.js" ]; then echo 'Ù…ÙˆØ¬ÙˆØ¯'; else echo 'Ù…ÙÙ‚ÙˆØ¯'; fi)" >> pwa-report.md
        echo "- ðŸ“± Responsive: $(if grep -q "viewport" index.html 2>/dev/null; then echo 'Ù†Ø¹Ù…'; else echo 'Ù„Ø§'; fi)" >> pwa-report.md
        echo "- ðŸŽ¨ Theme: $(if grep -q "theme-color" index.html 2>/dev/null; then echo 'Ù…Ø¶Ø¨ÙˆØ·'; else echo 'ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·'; fi)" >> pwa-report.md
        echo "" >> pwa-report.md
        echo "## Ø§Ù„ØªÙˆØµÙŠØ§Øª" >> pwa-report.md
        echo "1. Ø£Ø¶Ù Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£Ø­Ø¬Ø§Ù…" >> pwa-report.md
        echo "2. Ø­Ø³Ù† Ø£Ø¯Ø§Ø¡ service worker" >> pwa-report.md
        echo "3. Ø£Ø¶Ù Ø´Ø§Ø´Ø© splash" >> pwa-report.md
        
    - name: Upload PWA report
      uses: actions/upload-artifact@v4
      with:
        name: pwa-report
        path: pwa-report.md
